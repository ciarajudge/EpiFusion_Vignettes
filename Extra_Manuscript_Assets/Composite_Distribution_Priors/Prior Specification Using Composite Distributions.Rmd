---
title: "Prior Specification Using Composite Distributions"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(truncnorm)
library(ggplot2)
library(magrittr)
library(dplyr)
library(tidyverse)
```

## The Problem

It is not uncommon to want to specify priors or distributions of variables that have a non-parametric form. To accomodate this we added the option to EpiFusion to specify priors with non-parametric distributions that are the composite of two or more parametric distributions

```{r example_composite_dists, fig.height = 3}
a <- data.frame(Dist = "A", Sample = rtruncnorm(1000, mean = 0.2, sd = 0.05, a = 0, b = 1))
b <- data.frame(Dist = "B", Sample = rtruncnorm(1000, mean = 0.4, sd = 0.05, a = 0, b = 1))
combined <- rbind(a, b)

ggplot(combined, aes(x = Sample)) +
  geom_density(aes(col = Dist, fill = Dist), alpha = 0.4, bounds = c(0, 1)) +
  geom_density(linetype = 2, bounds = c(0, 1))

```

## Parameterising it in EpiFusion XML
In EpiFusion XML, prior distributions are specified inside the `priors` block, inside XML tags that describe the different variables (most essentially, `gamma`, `psi`, `phi` and some parameterisation of `beta` depending on the fitting method). For a given parameter, e.g. `phi` this can look a little like this:

```
<phi>
      <stepchange>false</stepchange>
      <disttype>TruncatedNormal</disttype>
      <mean>0.2</mean>
      <standarddev>0.05</standarddev>
      <lowerbound>0.0</lowerbound>
</phi>
```

In the above example, our parameterisation of `phi` is constant throughout the time series we are modelling (indicated by `<stepchange>false</stepchange>`). Our prior for phi is a simple truncated normal distribution.

To adjust this so that our prior is made of two composite distributions (like what is shown above) requires two small changes to the xml.

1. Add a new tag to the XML chunk `numdists` specifying the number of distributions involved
2. Enclose the details of the distributions into new 'sublevel' tags labelled with letters of the alphabet

In practice, here's what the adjusted XML should look like:

```
<phi>
  <stepchange>false</stepchange>
  <numdists>2</numdists>
  <a>
    <disttype>TruncatedNormal</disttype>
    <mean>0.2</mean>
    <standarddev>0.05</standarddev>
    <lowerbound>0.0</lowerbound>
  </a>
  <b>
    <disttype>TruncatedNormal</disttype>
    <mean>0.4</mean>
    <standarddev>0.05</standarddev>
    <lowerbound>0.0</lowerbound>
  </b>
</phi>
```
Above we specify that the `phi` prior is made up of two distributions, (`<numdists>2</numdists>`), which we have enclosed in chunks `<a>` and `<b>`.

## Validation by sampling from EpiFusion distribution
We generated 1000 samples from an EpiFusion prior distribution parameterised with the above XML code to verify that the expected distribution shape was obtained. Below we show these samples plotted with the samples generated for the above plot.

```{r sampling_validation}
epifusion_samples <- read.table("composite_distribution_samples.txt", header = F) %>%
  rename(Sample = V1) %>%
  mutate(Dist = "EpiFusion")
  
epifusion_and_r_samples <- rbind(combined, epifusion_samples) %>%
  mutate(Dist = ifelse(Dist != "EpiFusion", "R", Dist))

ggplot(epifusion_and_r_samples, aes(x = Sample)) +
  geom_density(aes(col = Dist, fill = Dist), alpha = 0.4, bounds = c(0, 1)) 

```

## Calculating the Prior Probability from the Composite Distribution

To ensure that the prior probability of this composite distribution is accurately calculated within EpiFusion for the Metropolis Hastings Algorithm, we calculate below the ECDF of the distribution generated by R, and compare it to the values obtained from EpiFusion for the encoded composite distribution.

``` {r empirical_composite_distribution}
r_cdf_function <- ecdf(combined$Sample)
r_cdf <- data.frame(Dist = "R", Value = seq(0.01, 0.6, 0.01), Density = r_cdf_function(seq(0.01, 0.6, 0.01)))
epifusion_cdf <- data.frame(Dist = "EpiFusion", Value = seq(0.01, 0.59, 0.01), Density =  read.table("composite_distribution_density.txt", header = F)[,1]) %>%
  mutate(Density = Density / sum(Density)) %>%
  mutate(Density = cumsum(Density))

epifusion_and_r_cdf <- rbind(r_cdf, epifusion_cdf)

ggplot(epifusion_and_r_cdf, aes(x = Value, y = Density)) +
  geom_line(aes(col = Dist), alpha = 0.6)

```









